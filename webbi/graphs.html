<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Graphs</title>
  <link rel="stylesheet" href="styles.css" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <div class="background">
    <div class="container">
      <h1 style="text-align: center;">Graphs</h1>

      <!-- Temperatur -->
      <div class="card">
        <h3>Temperature Over Time</h3>
        <canvas id="tempChart" height="100"></canvas>
      </div>

      <!-- OD -->
      <div class="card">
        <h3>Algae Concentration (OD) Over Time</h3>
        <canvas id="odChart" height="100"></canvas>
      </div>

      <!-- Pump -->
      <div class="card">
        <h3>Pump Speed Over Time</h3>
        <canvas id="pumpChart" height="100"></canvas>
      </div>

      <!-- Time Picker (below graphs) -->
      <style>
        .switch {
          position: relative;
          display: inline-block;
          width: 40px;
          height: 22px;
          vertical-align: middle;
        }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider {
          position: absolute;
          cursor: pointer;
          top: 0; left: 0; right: 0; bottom: 0;
          background-color: #003366;
          transition: .4s;
          border-radius: 22px;
        }
        .slider:before {
          position: absolute;
          content: "";
          height: 16px;
          width: 16px;
          left: 3px;
          bottom: 3px;
          background-color: #fff;
          transition: .4s;
          border-radius: 50%;
        }
        input:checked + .slider {
          background-color: #00b300;
        }
        input:checked + .slider:before {
          transform: translateX(18px);
        }
        .toggle-label, .range-label {
          color: #003366;
          font-weight: 500;
          margin-bottom: 0.5rem;
          display: flex;
          align-items: center;
          gap: 0.5rem;
        }
        .interval-fields {
          display: flex;
          flex-direction: row;
          gap: 2rem;
          justify-content: center;
          flex-wrap: wrap;
        }
        .interval-col {
          display: flex;
          flex-direction: column;
          align-items: center;
          min-width: 120px;
        }
      </style>
      <div class="interval-fields" style="margin: 30px 0 20px 0;">
        <div class="interval-col">
          <label class="range-label" for="fromDay">From:
            <input type="date" id="fromDay" min="2025-06-01" max="2025-06-30" value="2025-06-18" style="margin-left: 0.5rem;">
          </label>
          <label class="range-label" for="fromTime">Time:
            <input type="time" id="fromTime" style="margin-left: 0.5rem;">
          </label>
        </div>
        <div class="interval-col" id="toFields">
          <label class="range-label" for="toDay">To:
            <input type="date" id="toDay" min="2025-06-01" max="2025-06-30" value="2025-06-18" style="margin-left: 0.5rem;">
          </label>
          <label class="range-label" for="toTime">Time:
            <input type="time" id="toTime" style="margin-left: 0.5rem;">
          </label>
        </div>
        <div class="interval-col" style="justify-content: flex-end;">
          <label class="toggle-label">Live (updates until now)
            <span class="switch">
              <input type="checkbox" id="liveMode" checked>
              <span class="slider"></span>
            </span>
          </label>
          <button id="fetchBtn" style="margin-top: 1rem;">Show Data</button>
        </div>
      </div>

      <!-- ZurÃ¼ck Button -->
      <div style="text-align: center; margin-top: 30px;">
        <button onclick="window.location.href='index.html'">ðŸ”™ Back to Dashboard</button>
      </div>
    </div>
  </div>

  <script>
    const API_BASE = "http://localhost:8000";
    const maxPoints = 100;

    // Chart.js data objects
    const tempData = {
      labels: [],
      datasets: [{
        label: 'Temperature (Â°C)',
        borderColor: 'rgba(255, 0, 0, 1)',
        backgroundColor: 'rgba(255, 0, 0, 0.1)',
        data: [],
        tension: 0.3,
      }],
    };
    const odData = {
      labels: [],
      datasets: [{
        label: 'Algae Concentration (cells/mL)',
        borderColor: 'rgba(0, 128, 0, 1)',
        backgroundColor: 'rgba(0, 128, 0, 0.1)',
        data: [],
        tension: 0.3,
      }],
    };
    const pumpData = {
      labels: [],
      datasets: [{
        label: 'Pump Speed (%)',
        borderColor: 'rgba(0, 0, 255, 1)',
        backgroundColor: 'rgba(0, 0, 255, 0.1)',
        data: [],
        tension: 0.3,
      }],
    };

    // Chart.js chart objects
    const tempChart = new Chart(document.getElementById('tempChart'), {
      type: 'line',
      data: tempData,
      options: {
        responsive: true,
        animation: false,
        scales: {
          x: { title: { display: true, text: 'Time' } },
          y: { beginAtZero: true }
        }
      }
    });
    const odChart = new Chart(document.getElementById('odChart'), {
      type: 'line',
      data: odData,
      options: {
        responsive: true,
        animation: false,
        scales: {
          x: { title: { display: true, text: 'Time' } },
          y: { beginAtZero: true }
        }
      }
    });
    const pumpChart = new Chart(document.getElementById('pumpChart'), {
      type: 'line',
      data: pumpData,
      options: {
        responsive: true,
        animation: false,
        scales: {
          x: { title: { display: true, text: 'Time' } },
          y: { beginAtZero: true }
        }
      }
    });

    let pollInterval = null;
    let lastFromTime = null;
    let liveMode = true;

    // Fetch data from backend and update charts
    async function fetchAndShowData(fromTime = null) {
      let url = `${API_BASE}/data`;
      const params = [];
      if (fromTime) params.push(`from_time=${encodeURIComponent(fromTime)}`);
      if (params.length > 0) url += `?${params.join('&')}`;
      const res = await fetch(url);
      const data = await res.json();

      // Prepare arrays for charts
      const labels = [];
      const tempArr = [];
      const odArr = [];
      const pumpArr = [];

      data.slice(-maxPoints).forEach(entry => {
        const timeLabel = new Date(entry.timestamp).toLocaleTimeString();
        labels.push(timeLabel);
        tempArr.push(entry.temperature);
        odArr.push(entry.od_value);
        pumpArr.push(entry.pump_speed);
      });

      tempData.labels = odData.labels = pumpData.labels = labels;
      tempData.datasets[0].data = tempArr;
      odData.datasets[0].data = odArr;
      pumpData.datasets[0].data = pumpArr;
      tempChart.update();
      odChart.update();
      pumpChart.update();
    }

    function startLivePolling() {
      if (pollInterval) clearInterval(pollInterval);
      pollInterval = setInterval(() => fetchAndShowData(lastFromTime), 3000);
    }
    function stopLivePolling() {
      if (pollInterval) clearInterval(pollInterval);
      pollInterval = null;
    }

    document.getElementById('liveMode').addEventListener('change', (e) => {
      const toFields = document.getElementById('toFields');
      if (e.target.checked) {
        toFields.style.visibility = 'hidden';
        toFields.style.height = '0';
        // Start live polling immediately
        const fromDay = document.getElementById('fromDay').value || '2025-06-18';
        const fromTime = document.getElementById('fromTime').value;
        let lastFromTime = fromTime ? `${fromDay}T${fromTime}:00` : null;
        fetchAndShowData(lastFromTime, null);
        startLivePolling();
      } else {
        toFields.style.visibility = 'visible';
        toFields.style.height = 'auto';
        stopLivePolling();
      }
    });

    document.getElementById('fetchBtn').addEventListener('click', () => {
      const fromDay = document.getElementById('fromDay').value || '2025-06-18';
      const fromTime = document.getElementById('fromTime').value;
      liveMode = document.getElementById('liveMode').checked;
      let lastFromTime = fromTime ? `${fromDay}T${fromTime}:00` : null;
      let lastToTime = null;
      if (!liveMode) {
        const toDay = document.getElementById('toDay').value || fromDay;
        const toTime = document.getElementById('toTime').value;
        lastToTime = (toTime && toDay) ? `${toDay}T${toTime}:00` : null;
      }
      fetchAndShowData(lastFromTime, liveMode ? null : lastToTime);
      if (liveMode) {
        startLivePolling();
      } else {
        stopLivePolling();
      }
    });

    // On page load, show latest and start live polling
    window.addEventListener('DOMContentLoaded', () => {
      const fromDay = document.getElementById('fromDay').value || '2025-06-18';
      const fromTime = document.getElementById('fromTime').value;
      let lastFromTime = fromTime ? `${fromDay}T${fromTime}:00` : null;
      fetchAndShowData(lastFromTime, null);
      startLivePolling();
    });
  </script>
</body>
</html>